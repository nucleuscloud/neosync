on:
  pull_request:
    paths:
      - backend/**

name: Tests
jobs:
  test:
    name: run-tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    # services:
    #   postgres:
    #     image: postgres:14
    #     ports:
    #       - 5432:5432
    #     env:
    #       POSTGRES_DB: nucleus
    #       POSTGRES_PASSWORD: postgres
    #     # Set health checks to wait until postgres has started
    #     options: >-
    #       --health-cmd pg_isready
    #       --health-interval 10s
    #       --health-timeout 5s
    #       --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Granting private modules access
        run: |
          git config --global url."https://${{ secrets.REPO_PAT }}:x-oauth-basic@github.com/nucleuscloud".insteadOf "https://github.com/nucleuscloud"

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version-file: backend/go.mod
          cache-dependency-path: backend/go.sum

      - name: Vet
        run: |
          go vet ./...

      - name: Test
        run: |
          go test -race ./...
        # env:
        #   DB_HOST: localhost
        #   DB_PORT: '5432'
        #   DB_NAME: nucleus
        #   DB_USER: postgres
        #   DB_PASS: postgres
