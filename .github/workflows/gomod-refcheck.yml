on:
  pull_request:
    paths:
      - cli/go.mod
      - backend/go.mod
      - worker/go.mod
      - hack/refcheck/go.mod

name: Go Mod Ref Check
jobs:
  ref-check:
    name: go.mod ref check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # required to checkout all branches and history

      - name: Git
        run: git fetch --all

      - name: Set ownership
        run: |
          # this is to fix GIT not liking owner of the checkout dir
          chown -R $(id -u):$(id -g) $PWD

      - name: Foo
        run: |
          git --version
          ls -l .git
          ls -l .git/branches
          ls -l .git/refs
          ls -l .git/refs/remotes
          ls -l .git/refs/remotes/origin

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version-file: hack/refcheck/go.mod
          cache-dependency-path: hack/refcheck/go.sum

      - name: Ensure go.mod doesn't contain branch refs
        run: go run hack/refcheck/main.go
